<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Book Search â€” Book Store</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .fade-in { animation: fadeIn 0.5s ease-in forwards; }
    .slide-up { animation: slideUp 0.6s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center py-10">

  <!-- Loading Spinner -->
  <div id="loadingSpinner" class="text-center py-10">
    <svg class="animate-spin h-10 w-10 text-purple-700 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <p class="text-lg text-gray-600 mt-4">Loading data, please wait...</p>
  </div>

  <!-- Error Message -->
  <div id="errorMessage" class="hidden w-full max-w-md p-4 mb-6 bg-red-100 border border-red-400 text-red-700 rounded-lg"></div>

  <h1 id="mainTitle" class="text-4xl font-extrabold text-purple-700 mb-8 hidden">Find Your Next Read</h1>

  <!-- Step 1: Writer Dropdown -->
  <div id="writerSelectContainer" class="w-full max-w-md mb-6 hidden">
    <label class="block text-lg font-semibold mb-2 text-gray-700">Select Your Writer</label>
    <select id="writerSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
      <option value="">-- Choose a Writer --</option>
    </select>
  </div>

  <!-- Step 2: Category Dropdown -->
  <div id="categorySelectContainer" class="w-full max-w-md mb-6 hidden fade-in">
    <label class="block text-lg font-semibold mb-2 text-gray-700">Select Your Category</label>
    <select id="categorySelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
      <option value="">-- Choose a Category --</option>
    </select>
  </div>

  <!-- Step 3: Books Grid -->
  <div id="booksGrid" class="w-full max-w-5xl mt-10 hidden slide-up">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">Recommended Books</h2>
    <div id="booksContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
  </div>

  <script>
    const writerSelect = document.getElementById('writerSelect');
    const categorySelect = document.getElementById('categorySelect');
    const categorySelectContainer = document.getElementById('categorySelectContainer');
    const booksGrid = document.getElementById('booksGrid');
    const booksContainer = document.getElementById('booksContainer');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const errorMessage = document.getElementById('errorMessage');
    const mainContentElements = [
      document.getElementById('mainTitle'),
      document.getElementById('writerSelectContainer')
    ];

    let writers = [];
    let categories = [];
    let books = [];

    // ðŸ”¹ Fetch data securely via Netlify function (API key is hidden in backend)
    async function fetchSheetData(tabName) {
      const res = await fetch(`/.netlify/functions/fetchSheetData?tab=${tabName}`);
      if (!res.ok) {
        const errorBody = await res.json().catch(() => ({ error: `Failed to fetch ${tabName}: ${res.statusText}` }));
        throw new Error(errorBody.error || `HTTP error! status: ${res.status}`);
      }
      const data = await res.json();
      return data.values || [];
    }

    const showContent = () => {
      loadingSpinner.classList.add('hidden');
      mainContentElements.forEach(el => el.classList.remove('hidden'));
    };

    const showError = (message) => {
      loadingSpinner.classList.add('hidden');
      errorMessage.textContent = message;
      errorMessage.classList.remove('hidden');
    };

    async function loadData() {
      try {
        // Fetch all data in parallel for faster loading
        const [writerData, categoryData, bookData] = await Promise.all([
          fetchSheetData('Writers'),
          fetchSheetData('Categories'),
          fetchSheetData('Books')
        ]);

        // Process Writers
        if (writerData.length > 1) {
          writers = writerData.slice(1).map(row => ({ id: row[0], name: row[1] }));
          writerSelect.innerHTML = '<option value="">-- Choose a Writer --</option>' +
            writers.map(w => `<option value="${w.id}">${w.name}</option>`).join('');
        }

        // Process Categories
        if (categoryData.length > 1) {
          categories = categoryData.slice(1).map(row => ({ id: row[0], name: row[1] }));
        }

        // Process Books
        if (bookData.length > 1) {
          books = bookData.slice(1).map(row => ({
            id: row[0],
            title: row[1],
            writerId: row[2],
            categoryId: row[3],
            image: `assets/books/${row[4]}`
          }));
        }

        showContent();

      } catch (error) {
        console.error("Failed to load initial data:", error);
        showError(`Sorry, we couldn't load the book data. Please try refreshing the page. Error: ${error.message}`);
      }
    }

    writerSelect.addEventListener('change', () => {
      if (writerSelect.value) {
        const writerCategories = [...new Set(
          books.filter(b => b.writerId === writerSelect.value).map(b => b.categoryId)
        )];
        categorySelect.innerHTML = '<option value="">-- Choose a Category --</option>' +
          categories.filter(c => writerCategories.includes(c.id))
            .map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        categorySelectContainer.classList.remove('hidden');
      } else {
        categorySelectContainer.classList.add('hidden');
        booksGrid.classList.add('hidden');
      }
    });

    categorySelect.addEventListener('change', () => {
      if (categorySelect.value) {
        const filteredBooks = books.filter(b => 
          b.writerId === writerSelect.value && b.categoryId === categorySelect.value
        );

        if (filteredBooks.length > 0) {
          booksContainer.innerHTML = filteredBooks.map(book => `
            <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition">
              <img src="${book.image}" alt="Book Cover" class="w-full h-56 object-cover">
              <div class="p-4">
                <h3 class="font-bold text-lg text-purple-700">${book.title}</h3>
                <p class="text-sm text-gray-600">by ${writers.find(w => w.id === book.writerId)?.name || "Unknown"}</p>
                <p class="text-xs mt-2 text-gray-500">Category: ${categories.find(c => c.id === book.categoryId)?.name || "N/A"}</p>
              </div>
            </div>
          `).join('');
        } else {
          booksContainer.innerHTML = `<p class="col-span-full text-center text-gray-500 py-8">Sorry, no books found for this selection.</p>`;
        }
        booksGrid.classList.remove('hidden');
      } else {
        booksGrid.classList.add('hidden');
      }
    });

    loadData();
  </script>

</body>
</html>
